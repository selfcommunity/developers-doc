name: documentation

on:
  push:
    branches: [main]
  repository_dispatch:
    types: [community-ui-prerelease]

jobs:
  update_documentation:
    if: github.event_name == 'community-ui-prerelease'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          submodules: true
      - uses: actions/setup-node@v2
        with:
          node-version: '14.x'
      - name: Update package.json @selfcommunity/i18n dependency
        uses: jossef/action-set-json-field@v1
        with:
          file: package.json
          field: dependencies.@selfcommunity/i18n
          value: "^${{ github.event.client_payload.i18n }}"
      - name: Update package.json @selfcommunity/core dependency
        uses: jossef/action-set-json-field@v1
        with:
          file: package.json
          field: dependencies.@selfcommunity/core
          value: "^${{ github.event.client_payload.core }}"
      - name: Update package.json @selfcommunity/ui dependency
        uses: jossef/action-set-json-field@v1
        with:
          file: package.json
          field: dependencies.@selfcommunity/ui
          value: "^${{ github.event.client_payload.ui }}"
      - name: Update package.json @selfcommunity/templates dependency
        uses: jossef/action-set-json-field@v1
        with:
          file: package.json
          field: dependencies.@selfcommunity/templates
          value: "^${{ github.event.client_payload.templates }}"
      - name: Update community-ui submodule
        run: |
          git config --global user.email "fede.torre@gmail.com"
          git config --global user.name "fedetorre"
          git submodule update --remote --merge
          git add sdk/community-ui/
          git add package.json
          git commit -m 'update package.json and gitlink to community-ui'
          git push
  release:
    if: github.event_name == 'push'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          submodules: true
      - uses: actions/setup-node@v2
        with:
          node-version: '14.x'
      - uses: webfactory/ssh-agent@v0.5.0
        with:
          ssh-private-key: ${{ secrets.GH_PAGES_DEPLOY }}
      - name: Release to GitHub Pages
        env:
          USE_SSH: true
          GIT_USER: git
          NODE_OPTIONS: '--max_old_space_size=4096'
        run: |
          git config --global user.email "fede.torre@gmail.com"
          git config --global user.name "gh-actions"
          yarn --cwd "sdk/community-ui" bootstrap
          if [ -e yarn.lock ]; then
            yarn install --frozen-lockfile
          elif [ -e package-lock.json ]; then
            npm ci
          else
            npm i
          fi
          npm run deploy
